<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phone Logger</title>
  <link rel="stylesheet" href="output.css">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      background: #f8f9fa;
    }
    .form-group {
      display: flex;
      align-items: flex-start;
      margin-bottom: 16px;
      gap: 16px;
    }
    label {
      flex: 0 0 140px;
      padding-top: 8px;
      font-weight: 500;
      color: #333;
    }
    input, textarea {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 14px;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #0d6efd;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    #sidebar {
      width: 14rem;
      transition: width 0.2s ease;
    }
    #sidebar.collapsed {
      width: 4rem;
    }
    #sidebar.collapsed #logo {
      opacity: 0;
      width: 0;
      overflow: hidden;
    }
    #sidebar.collapsed #sidebar-header {
      justify-content: center;
    }
    #sidebar.collapsed #chevron {
      transform: rotate(180deg);
    }
    #sidebar.collapsed .nav-label {
      opacity: 0;
      width: 0;
      overflow: hidden;
      white-space: nowrap;
    }
  </style>
</head>
<body class="flex min-h-screen">
  <aside id="sidebar" class="flex flex-col bg-slate-800 text-white shrink-0 border-r border-slate-700">
    <div id="sidebar-header" class="flex items-center justify-between h-14 px-4 border-b border-slate-700 shrink-0 min-w-0">
      <span id="logo" class="font-semibold truncate">Phone Logger</span>
      <button id="sidebar-toggle" type="button" class="p-1.5 rounded hover:bg-slate-700 transition-colors shrink-0" aria-label="Toggle sidebar">
        <svg class="w-5 h-5 transition-transform duration-200" id="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5m-6-15l7.5 7.5-7.5 7.5" />
        </svg>
      </button>
    </div>
    <nav class="flex-1 py-2 overflow-hidden">
      <a href="#dashboard" data-page="dashboard" class="nav-link flex items-center gap-3 px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
        <svg class="w-5 h-5 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
        </svg>
        <span class="nav-label">Dashboard</span>
      </a>
      <a href="#logs" data-page="logs" class="nav-link flex items-center gap-3 px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
        <svg class="w-5 h-5 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
        </svg>
        <span class="nav-label">Logs</span>
      </a>
      <a href="#entry" data-page="entry" class="nav-link flex items-center gap-3 px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
        <svg class="w-5 h-5 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
        <span class="nav-label">New Entry</span>
      </a>
      <a href="#" class="flex items-center gap-3 px-4 py-2.5 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
        <svg class="w-5 h-5 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
        </svg>
        <span class="nav-label">Settings</span>
      </a>
    </nav>
  </aside>
  <main class="flex-1 overflow-auto p-6">
    <!-- Dashboard Page -->
    <div id="page-dashboard" class="page max-w-4xl">
      <h1 class="text-2xl font-semibold text-slate-800 mb-6">Dashboard</h1>

      <!-- Graph Placeholder -->
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-6">
        <h2 class="text-sm font-medium text-slate-500 mb-4">Call Volume Over Time</h2>
        <div class="h-64 bg-slate-100 rounded-lg flex items-center justify-center border-2 border-dashed border-slate-300">
          <span class="text-slate-400">Chart placeholder</span>
        </div>
      </div>

      <!-- Metrics -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
          <p class="text-sm font-medium text-slate-500">Last Week</p>
          <p id="metric-last-week" class="text-2xl font-bold text-slate-800 mt-1">42</p>
          <p class="text-xs text-slate-400 mt-1">phone calls</p>
        </div>
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
          <p class="text-sm font-medium text-slate-500">This Week</p>
          <p id="metric-this-week" class="text-2xl font-bold text-slate-800 mt-1">48</p>
          <p class="text-xs text-slate-400 mt-1">phone calls</p>
        </div>
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
          <p class="text-sm font-medium text-slate-500">Change</p>
          <p id="metric-change" class="text-2xl font-bold mt-1">
            <span id="metric-change-value" class="text-emerald-600">+14.3%</span>
          </p>
          <p class="text-xs text-slate-400 mt-1">vs last week</p>
        </div>
      </div>

      <!-- Add Phone Call Widget -->
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <button type="button" id="add-call-toggle" class="w-full flex items-center justify-between px-4 py-3 text-left hover:bg-slate-50 transition-colors">
          <h2 class="font-medium text-slate-800">Add Phone Call</h2>
          <svg id="add-call-chevron" class="w-5 h-5 text-slate-400 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </button>
        <div id="add-call-form" class="border-t border-slate-200 px-4 py-4">
          <form id="dashboard-call-form" class="max-w-xl">
            <div class="form-group">
              <label for="d-estimator">Estimator</label>
              <input class="w-full" type="text" id="d-estimator" name="estimator">
            </div>
            <div class="form-group">
              <label for="d-customerName">Customer Name</label>
              <input class="w-full" type="text" id="d-customerName" name="customerName">
            </div>
            <div class="form-group relative">
              <label for="d-companyName">Company Name</label>
              <input class="w-full" type="text" id="d-companyName" name="companyName" list="company-suggestions" autocomplete="off">
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <input class="w-full" type="text" id="address" name="address">
            </div>
            <div class="form-group">
              <label for="town">Town</label>
              <input class="w-full" type="text" id="town" name="town">
            </div>
            <div class="form-group">
              <label for="d-telephone">Telephone</label>
              <input class="w-full" type="tel" id="d-telephone" name="telephone">
            </div>
            <div class="form-group">
              <label for="cellphone">Cellphone</label>
              <input class="w-full" type="tel" id="cellphone" name="cellphone">
            </div>
            <div class="form-group">
              <label for="d-description">Description of Work</label>
              <textarea class="w-full" id="d-description" name="descriptionOfWork" rows="3"></textarea>
            </div>
            <button type="submit" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors text-sm font-medium">
              Log Call
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Logs Page -->
    <div id="page-logs" class="page hidden">
      <h1 class="text-2xl font-semibold text-slate-800 mb-6">Call Logs</h1>
      <div id="logs-list" class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 max-w-2xl">
        <p class="text-slate-500">Loading…</p>
      </div>
    </div>

    <!-- Call Detail Popup -->
    <div id="call-popup" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200">
          <h2 class="text-lg font-semibold text-slate-800">Call Details</h2>
          <button type="button" id="call-popup-close" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500 hover:text-slate-700">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div id="call-popup-body" class="p-6 overflow-auto flex-1 text-sm space-y-3"></div>
      </div>
    </div>

    <!-- New Entry Page (Full Form) -->
    <div id="page-entry" class="page hidden">
      <h1 class="text-2xl font-semibold text-slate-800 mb-6">New Entry</h1>
      <form id="full-entry-form" class="max-w-xl">
        <div class="form-group">
          <label for="estimator">Estimator</label>
          <input class="w-full" type="text" id="estimator" name="estimator">
        </div>
        <div class="form-group">
          <label for="customerName">Customer Name</label>
          <input class="w-full" type="text" id="customerName" name="customerName">
        </div>
        <div class="form-group relative">
          <label for="companyName">Company Name</label>
          <input class="w-full" type="text" id="companyName" name="companyName" list="company-suggestions" autocomplete="off">
        </div>
        <div class="form-group">
          <label for="address">Address</label>
          <input class="w-full" type="text" id="address" name="address">
        </div>
        <div class="form-group">
          <label for="town">Town</label>
          <input class="w-full" type="text" id="town" name="town">
        </div>
        <div class="form-group">
          <label for="telephone">Telephone</label>
          <input class="w-full" type="tel" id="telephone" name="telephone">
        </div>
        <div class="form-group">
          <label for="cellphone">Cellphone</label>
          <input class="w-full" type="tel" id="cellphone" name="cellphone">
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input class="w-full" type="email" id="email" name="email">
        </div>
        <div class="form-group">
          <label for="descriptionOfWork">Description of Work</label>
          <textarea class="w-full" id="descriptionOfWork" name="descriptionOfWork"></textarea>
        </div>
        <button type="submit" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors text-sm font-medium">
          Save Entry
        </button>
      </form>
    </div>
  </main>
  <datalist id="company-suggestions"></datalist>
  <script>
    // Sidebar collapse
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (sidebarCollapsed) sidebar.classList.add('collapsed');

    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    });

    // Page navigation
    const pages = document.querySelectorAll('.page');
    const navLinks = document.querySelectorAll('.nav-link');

    function showPage(pageId) {
      pages.forEach(p => {
        p.classList.toggle('hidden', p.id !== `page-${pageId}`);
      });
      navLinks.forEach(link => {
        const isActive = link.dataset.page === pageId;
        link.classList.toggle('bg-slate-700', isActive);
        link.classList.toggle('text-white', isActive);
        link.classList.toggle('text-slate-300', !isActive);
      });
      window.location.hash = pageId;
    }

    function getPageFromHash() {
      const hash = window.location.hash.slice(1) || 'dashboard';
      return ['dashboard', 'logs', 'entry'].includes(hash) ? hash : 'dashboard';
    }

    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        showPage(link.dataset.page);
      });
    });
    window.addEventListener('hashchange', () => showPage(getPageFromHash()));
    showPage(getPageFromHash());

    refreshCallsData();

    // Add phone call widget toggle
    const addCallToggle = document.getElementById('add-call-toggle');
    const addCallForm = document.getElementById('add-call-form');
    const addCallChevron = document.getElementById('add-call-chevron');
    let addCallExpanded = true;

    addCallToggle.addEventListener('click', () => {
      addCallExpanded = !addCallExpanded;
      addCallForm.classList.toggle('hidden', !addCallExpanded);
      addCallChevron.classList.toggle('rotate-180', !addCallExpanded);
    });

    // Form data helper
    function formToCall(form) {
      const fd = new FormData(form);
      return {
        estimator: fd.get('estimator') || '',
        customerName: fd.get('customerName') || '',
        companyName: fd.get('companyName') || '',
        address: fd.get('address') || '',
        town: fd.get('town') || '',
        telephone: fd.get('telephone') || '',
        cellphone: fd.get('cellphone') || '',
        email: fd.get('email') || '',
        descriptionOfWork: fd.get('descriptionOfWork') || '',
      };
    }

    async function saveCallAndRefresh(call) {
      if (typeof window.callsApi === 'undefined') {
        alert('Save requires the Electron app. Run with: npm start');
        return;
      }
      try {
        await window.callsApi.saveCall(call);
        refreshCallsData();
      } catch (err) {
        alert('Failed to save: ' + (err?.message || err));
      }
    }

    async function refreshCallsData() {
      if (typeof window.callsApi === 'undefined') return;
      try {
        const { calls } = await window.callsApi.getCalls();
        updateMetricsFromCalls(calls);
        renderLogs(calls);
        updateCompanySuggestions(calls);
      } catch (_) {}
    }

    function updateCompanySuggestions(calls) {
      const datalist = document.getElementById('company-suggestions');
      if (!datalist) return;
      const companies = [...new Set((calls || [])
        .map((c) => (c.companyName || '').trim())
        .filter(Boolean)
      )].sort((a, b) => a.localeCompare(b));
      datalist.innerHTML = companies.map((c) => `<option value="${escapeHtml(c)}">`).join('');
    }

    function getWeekBounds(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(d);
      monday.setDate(diff);
      monday.setHours(0, 0, 0, 0);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      return { monday, sunday };
    }

    function updateMetricsFromCalls(calls) {
      const now = new Date();
      const thisWeek = getWeekBounds(now);
      const lastWeekStart = new Date(thisWeek.monday);
      lastWeekStart.setDate(lastWeekStart.getDate() - 7);
      const lastWeekEnd = new Date(lastWeekStart);
      lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
      lastWeekEnd.setHours(23, 59, 59, 999);
      const lastWeek = calls.filter((c) => {
        const t = new Date(c.timestamp);
        return t >= lastWeekStart && t <= lastWeekEnd;
      }).length;
      const thisWeekCount = calls.filter((c) => {
        const t = new Date(c.timestamp);
        return t >= thisWeek.monday && t <= thisWeek.sunday;
      }).length;
      updateMetrics({ lastWeek, thisWeek: thisWeekCount });
    }

    let sortedCalls = [];

    function renderLogs(calls) {
      const container = document.getElementById('logs-list');
      if (!container) return;
      if (!calls || calls.length === 0) {
        sortedCalls = [];
        container.innerHTML = '<p class="text-slate-500">No call logs yet.</p>';
        return;
      }
      sortedCalls = [...calls].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      container.innerHTML = sortedCalls.map((c, i) => {
        const date = new Date(c.timestamp).toLocaleString();
        const name = c.customerName || c.companyName || '(No name)';
        return `<div class="log-entry border-b border-slate-200 py-3 last:border-0 cursor-pointer hover:bg-slate-50 -mx-2 px-2 rounded transition-colors" data-index="${i}">
          <p class="font-medium text-slate-800">${escapeHtml(name)}</p>
          <p class="text-sm text-slate-500">${escapeHtml(date)} · ${escapeHtml(c.estimator || '-')}</p>
          ${c.descriptionOfWork ? `<p class="text-sm text-slate-600 mt-1">${escapeHtml(c.descriptionOfWork.slice(0, 100))}${c.descriptionOfWork.length > 100 ? '…' : ''}</p>` : ''}
        </div>`;
      }).join('');
    }

    function showCallDetail(call) {
      const popup = document.getElementById('call-popup');
      const body = document.getElementById('call-popup-body');
      const date = call.timestamp ? new Date(call.timestamp).toLocaleString() : '-';
      const fields = [
        ['Date', date],
        ['Estimator', call.estimator],
        ['Customer Name', call.customerName],
        ['Company Name', call.companyName],
        ['Address', call.address],
        ['Town', call.town],
        ['Telephone', call.telephone],
        ['Cellphone', call.cellphone],
        ['Email', call.email],
        ['Description of Work', call.descriptionOfWork],
      ];
      body.innerHTML = fields.map(([label, value]) => `
        <div>
          <p class="font-medium text-slate-500 text-xs uppercase tracking-wide">${escapeHtml(label)}</p>
          <p class="text-slate-800 mt-0.5">${escapeHtml(value || '-')}</p>
        </div>
      `).join('');
      popup.classList.remove('hidden');
    }

    function hideCallDetail() {
      document.getElementById('call-popup')?.classList.add('hidden');
    }

    document.getElementById('logs-list')?.addEventListener('click', (e) => {
      const entry = e.target.closest('.log-entry');
      if (entry && sortedCalls[parseInt(entry.dataset.index, 10)]) {
        showCallDetail(sortedCalls[parseInt(entry.dataset.index, 10)]);
      }
    });

    document.getElementById('call-popup-close')?.addEventListener('click', hideCallDetail);
    document.getElementById('call-popup')?.addEventListener('click', (e) => {
      if (e.target.id === 'call-popup') hideCallDetail();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideCallDetail();
    });

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s ?? '';
      return div.innerHTML;
    }

    document.getElementById('dashboard-call-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const call = formToCall(e.target);
      await saveCallAndRefresh(call);
      e.target.reset();
    });
    document.getElementById('full-entry-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const call = formToCall(e.target);
      await saveCallAndRefresh(call);
      e.target.reset();
    });

    // Metrics
    function updateMetrics({ lastWeek, thisWeek }) {
      document.getElementById('metric-last-week').textContent = lastWeek;
      document.getElementById('metric-this-week').textContent = thisWeek;
      const change = lastWeek > 0 ? ((thisWeek - lastWeek) / lastWeek * 100).toFixed(1) : 0;
      const el = document.getElementById('metric-change-value');
      el.textContent = (change >= 0 ? '+' : '') + change + '%';
      el.className = change >= 0 ? 'text-emerald-600' : 'text-red-600';
    }
  </script>
</body>
</html>
